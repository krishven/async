
import sys
import os
configHashMap={}
subProcessHashMap={}
resProcessHashMap={}
cliProcessHashMap={}

class AppRequest():
    def __init__(self, subId,resId,clientProcId):
        self.subId = subId
        self.resId = resId
        self.clientId = clientProcId

def readConfigFile(fileName):
	with open(fileName) as f:
    		lines = f.read().splitlines()
	for line in lines:
		temp = line.split("=")
		configHashMap[temp[0]]=temp[1]
'''
	print(" key \t\t value\n")
	for key in configHashMap:
		print("{0} \t\t {1}".format(key,configHashMap[key]))
'''

class Client(process):
    def setup(subCoIdMap:dict,configFile:str): 
        self.resumeFlag=False 
        self.subCoId=None
        pass #print("poda:",subCoId)

    def run():
        output("hello Client!")
        readConfigFile(sys.argv[1])
        #print ("myid: ",self.id)
        appReq = AppRequest(1,1,self.id)
        self.subCoId = subCoIdMap[1]
        send((appReq,),to=subCoId)
        await(self.resumeFlag)
        
    def receive(msg=(result,), from_=self.subCoId):
        output("Got Response from subco:" , result)
        self.resumeFlag=True

        #self.clearFlag=True
        #send((True,), to=reqObject.clientId)

class SubjectCoordinator(process):
    def setup(clientProcId:Client,configFile:str):
        self.clearFlag=False

    def run():
        output("hello SubCo!")
        await(self.clearFlag)

    def receive(msg=(reqObject,), from_=clientProcId):
        output("Got hello from client",reqObject.clientId)
        self.clearFlag=True
        send((True,), to=reqObject.clientId)
    
class ResourceCoordinator(process):
    def setup(p:Pong, nrounds:int): pass

    def run():
        output("hello ResCo!")



def main():
    config(clock='Lamport')
    n=1
    readConfigFile(sys.argv[1])
    numCoordinators = int(configHashMap['numCoordinators'])
    
    subCoProcIds = new(SubjectCoordinator, num = int(numCoordinators/2))
    resCoProcIds = new(ResourceCoordinator, num = numCoordinators - int(numCoordinators/2) )
    clientProcIds = new(Client, num=int(configHashMap['numClients']))
 #   setup(subCoProcIds
    i=0
    for procId in subCoProcIds:
        subProcessHashMap[i]=procId
        i+=1

    i=0
    for procId in resCoProcIds:
        resProcessHashMap[i]=procId
        i+=1


    i=0
    for procId in clientProcIds:
        cliProcessHashMap[i]=procId
        i+=1

    setup(subCoProcIds,(clientProcIds,sys.argv[1],)) 
    setup(clientProcIds,(subProcessHashMap,sys.argv[1],))    
    start(subCoProcIds)
    start(resCoProcIds)
    start(clientProcIds)